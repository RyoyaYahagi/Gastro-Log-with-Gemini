<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gastro Log (Gemini AI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        main { padding-top: 80px; padding-bottom: 90px; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input::-webkit-calendar-picker-indicator { opacity: 100; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: start; padding-top: 4px; border-radius: 8px; font-size: 0.8rem; position: relative; cursor: pointer; }
        .calendar-day:hover { background-color: #f3f4f6; }
        .calendar-day.selected { background-color: #eff6ff; border: 2px solid #3b82f6; font-weight: bold; }
        .calendar-day.today { background-color: #fff7ed; border: 1px solid #fdba74; }
        .dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 2px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -8px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e5e7eb; border-radius: 2px; }
        
        /* å‰Šé™¤å¯èƒ½ã‚¿ã‚°ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .tag-removable { cursor: pointer; transition: all 0.2s; }
        .tag-removable:hover { opacity: 0.7; transform: scale(0.95); }
        .tag-removable::after { content: '\f00d'; font-family: "Font Awesome 6 Free"; font-weight: 900; margin-left: 6px; opacity: 0.5; font-size: 0.8em; }
    </style>
</head>
<body class="text-gray-800 font-sans antialiased">
    <header class="bg-white shadow-sm fixed top-0 left-0 w-full z-50 h-16 flex justify-between items-center px-4">
        <h1 class="text-xl font-bold text-blue-600 flex items-center"><i class="fa-solid fa-notes-medical mr-2"></i>Gastro Log</h1>
        <button onclick="clearAllData()" class="text-xs text-gray-400 hover:text-red-600 flex items-center"><i class="fa-solid fa-trash mr-1"></i> å±¥æ­´å‰Šé™¤</button>
    </header>

    <main class="max-w-md mx-auto p-4 min-h-screen">
        <section id="view-analyze" class="view-section active">
            <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
                <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3">é£Ÿäº‹ãƒ»å†™çœŸ</h2>
                <div class="mb-4">
                    <label for="cameraInput" id="imageUploadLabel" class="cursor-pointer block w-full h-40 border-2 border-dashed border-blue-200 rounded-xl flex flex-col justify-center items-center hover:bg-blue-50 transition relative overflow-hidden bg-gray-50">
                        <div id="uploadPlaceholder" class="flex flex-col items-center text-gray-400"><i class="fa-solid fa-camera text-2xl mb-2"></i><span class="text-xs">å†™çœŸã‚’æ’®å½±ãƒ»é¸æŠ</span></div>
                        <img id="previewImage" class="hidden absolute inset-0 w-full h-full object-cover" />
                        <button id="removeImageBtn" onclick="removeImage(event)" class="hidden absolute top-2 right-2 bg-gray-800 bg-opacity-60 text-white rounded-full w-8 h-8 flex items-center justify-center z-10 hover:bg-red-600 transition"><i class="fa-solid fa-xmark"></i></button>
                    </label>
                    <input type="file" id="cameraInput" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                </div>
                <div class="mb-6 relative">
                    <textarea id="textInput" rows="2" placeholder="é£Ÿäº‹ã®ãƒ¡ãƒ¢ï¼ˆä¾‹: ãƒ©ãƒ¼ãƒ¡ãƒ³å¤§ç››ã‚Šã€å‘³æ¿ƒã„ã‚ï¼‰" class="w-full p-3 border border-gray-200 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-gray-50" oninput="checkAnalyzeable()"></textarea>
                </div>

                <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3 border-t pt-4">ç”Ÿæ´»ãƒ»ä½“èª¿ãƒ­ã‚°</h2>
                <div id="autoFillMessage" class="hidden mb-3 bg-indigo-50 text-indigo-700 px-3 py-2 rounded-lg text-xs flex items-center animate-pulse">
                    <i class="fa-solid fa-mobile-screen-button mr-2"></i>å¤–éƒ¨ã‚¢ãƒ—ãƒªã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ
                </div>
                
                <div class="mb-4 bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-gray-600"><i class="fa-solid fa-bolt mr-1"></i>ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«</label>
                        <span id="stressValueDisplay" class="text-sm font-bold text-blue-600 bg-white px-2 py-0.5 rounded border border-blue-100">5</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-400">ä½</span>
                        <input type="range" id="stressInput" min="1" max="10" value="5" class="flex-1" oninput="updateStressDisplay(this.value)">
                        <span class="text-xs text-gray-400">é«˜</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="block text-xs font-bold text-gray-600 mb-1"><i class="fa-solid fa-bed mr-1"></i>ç¡çœ æ™‚é–“(h)</label><input type="number" id="sleepTime" step="0.5" placeholder="7.0" class="w-full p-2 border border-gray-200 rounded-lg bg-gray-50 text-sm"></div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1"><i class="fa-solid fa-star-half-stroke mr-1"></i>ç¡çœ ã®è³ª</label>
                        <select id="sleepQuality" class="w-full p-2 border border-gray-200 rounded-lg bg-gray-50 text-sm"><option value="">-</option><option value="good">è‰¯ã„</option><option value="normal">æ™®é€š</option><option value="bad">æ‚ªã„</option></select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="block text-xs font-bold text-gray-600 mb-1"><i class="fa-solid fa-shoe-prints mr-1"></i>æ­©æ•°(æ­©)</label><input type="number" id="stepsInput" placeholder="5000" class="w-full p-2 border border-gray-200 rounded-lg bg-gray-50 text-sm"></div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1"><i class="fa-solid fa-pills mr-1"></i>è–¬ãƒ»ã‚µãƒ—ãƒª</label>
                        <div class="relative"><input type="text" id="medicationInput" list="medicationHistoryList" placeholder="é¸æŠ/å…¥åŠ›" autocomplete="off" class="w-full p-2 border border-gray-200 rounded-lg bg-gray-50 text-sm"><datalist id="medicationHistoryList"></datalist></div>
                    </div>
                </div>
                <div class="mb-6"><label class="block text-xs font-bold text-gray-600 mb-1"><i class="fa-solid fa-person-walking mr-1"></i>ãã®ä»–ã®é‹å‹•</label><input type="text" id="exerciseInput" placeholder="ä¾‹: ãƒ¨ã‚¬15åˆ†" class="w-full p-2 border border-gray-200 rounded-lg bg-gray-50 text-sm"></div>

                <div id="loadingArea" class="hidden flex flex-col items-center justify-center py-6 bg-blue-50 rounded-xl mb-4"><div class="loader mb-3"></div><p class="text-sm text-blue-600 font-bold animate-pulse">æˆåˆ†ã‚’è©³ç´°åˆ†æä¸­...</p></div>
                <div class="flex gap-3" id="actionButtons">
                    <button onclick="saveLog(false)" id="quickSaveBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3 px-2 rounded-xl text-sm transition flex flex-col items-center justify-center"><span class="text-xs mb-0.5"><i class="fa-solid fa-pen mr-1"></i>è§£æã›ãš</span>ãã®ã¾ã¾è¨˜éŒ²</button>
                    <button onclick="analyze()" id="analyzeBtn" class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center" disabled><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>è©³ç´°è§£æã—ã¦è¨˜éŒ²</button>
                </div>
            </div>
            
            <div id="resultArea" class="hidden bg-white rounded-xl shadow-sm border-l-4 border-green-500 overflow-hidden mb-8">
                <div class="p-5">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg flex items-center"><i class="fa-solid fa-list-check text-green-500 mr-2"></i>æ¤œå‡ºã•ã‚ŒãŸé£Ÿæ</h3>
                        <span class="text-xs text-gray-400">ã‚¿ãƒƒãƒ—ã—ã¦å‰Šé™¤ <i class="fa-regular fa-trash-can ml-1"></i></span>
                    </div>
                    <div id="tagsContainer" class="flex flex-wrap gap-2 mb-5"></div>
                    <button onclick="saveLog(true)" class="w-full bg-green-50 hover:bg-green-100 text-green-700 font-bold py-3 px-4 rounded-xl flex items-center justify-center transition"><i class="fa-solid fa-floppy-disk mr-2"></i>ã“ã®å†…å®¹ã§ä¿å­˜</button>
                </div>
            </div>
        </section>

        <section id="view-history" class="view-section">
            <div id="historyStickyTabs" class="sticky top-16 bg-gray-100 z-40 pb-4 pt-1">
                <div class="flex bg-white rounded-lg shadow-sm p-1">
                    <button onclick="toggleHistoryView('list')" id="btnViewList" class="flex-1 py-2 text-sm font-bold rounded-md bg-blue-600 text-white transition shadow-sm"><i class="fa-solid fa-list-ul mr-1"></i>ãƒªã‚¹ãƒˆ</button>
                    <button onclick="toggleHistoryView('calendar')" id="btnViewCalendar" class="flex-1 py-2 text-sm font-bold rounded-md text-gray-500 hover:bg-gray-50 transition"><i class="fa-solid fa-calendar-days mr-1"></i>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5 mb-6 z-0">
                <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4 flex items-center"><i class="fa-solid fa-chart-simple mr-2"></i>ã‚ˆãæ‘‚ã‚‹æˆåˆ† (TOP 5)</h2>
                <div id="statsContainer" class="space-y-3"></div>
            </div>
            <div id="calendarContainer" class="hidden bg-white rounded-xl shadow-sm p-4 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="text-gray-400 hover:text-blue-600 p-2"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 id="calendarTitle" class="text-lg font-bold text-gray-700"></h2>
                    <button onclick="changeMonth(1)" class="text-gray-400 hover:text-blue-600 p-2"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-gray-400">
                    <span class="text-red-400">æ—¥</span><span>æœˆ</span><span>ç«</span><span>æ°´</span><span>æœ¨</span><span>é‡‘</span><span class="text-blue-400">åœŸ</span>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
                <div class="mt-4 flex justify-center gap-4 text-xs text-gray-500">
                    <div class="flex items-center"><div class="dot bg-red-500 mr-1"></div>æ³¨æ„ã‚ã‚Š</div>
                    <div class="flex items-center"><div class="dot bg-green-500 mr-1"></div>è‰¯å¥½</div>
                    <div class="flex items-center"><div class="dot bg-blue-400 mr-1"></div>ãƒ­ã‚°ã®ã¿</div>
                </div>
            </div>
            <h2 id="historyListTitle" class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4 pl-2">è¨˜éŒ²ãƒ­ã‚°</h2>
            <div id="historyList" class="space-y-4"></div>
        </section>

        <section id="view-settings" class="view-section">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h2 class="text-xl font-bold mb-6 flex items-center"><i class="fa-solid fa-sliders mr-2"></i>è¨­å®š</h2>
                <div class="mb-6"><label class="block text-sm font-bold mb-2 text-gray-700">Gemini API Key <span class="text-red-500">*</span></label><div class="relative"><input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10"><i class="fa-solid fa-key absolute top-3.5 right-3 text-gray-300"></i></div></div>
                <div class="mb-6"><label class="block text-sm font-bold mb-2 text-gray-700">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</label><div id="modelSelectContainer" class="relative mb-2"><select id="modelSelect" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none"><option value="gemini-2.5-flash">gemini-2.5-flash (æ¨å¥¨)</option><option value="gemini-2.0-flash">gemini-2.0-flash</option></select><i class="fa-solid fa-chevron-down absolute top-4 right-4 text-gray-400 pointer-events-none"></i></div><div id="modelInputContainer" class="relative mb-2 hidden"><input type="text" id="modelInput" placeholder="ãƒ¢ãƒ‡ãƒ«åã‚’æ‰‹å…¥åŠ›" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"><i class="fa-solid fa-robot absolute top-3.5 right-3 text-gray-300"></i></div><div class="flex gap-2"><button onclick="fetchModels()" id="fetchModelsBtn" class="flex-1 text-xs bg-blue-50 text-blue-700 font-bold px-3 py-2.5 rounded-lg hover:bg-blue-100 transition flex items-center justify-center"><i class="fa-solid fa-cloud-arrow-down mr-1"></i>ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’æ›´æ–°</button><button onclick="toggleModelInputMode()" class="text-xs bg-gray-100 text-gray-500 font-bold px-3 py-2.5 rounded-lg hover:bg-gray-200 transition"><i class="fa-solid fa-pen mr-1"></i>æ‰‹å…¥åŠ›</button></div><p id="modelFetchStatus" class="text-xs text-gray-400 mt-2 h-4"></p></div>
                <div class="mb-8 pt-6 border-t border-gray-100"><label class="block text-sm font-bold mb-2 text-gray-700">ä¿å­˜ã•ã‚ŒãŸè–¬ãƒªã‚¹ãƒˆ</label><p class="text-xs text-gray-400 mb-2">ã€Œè¨˜éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æ–°ã—ã„è–¬ã®åå‰ãŒè‡ªå‹•ã§ã“ã“ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p><div class="flex gap-2"><button onclick="clearMedicationHistory()" class="text-xs bg-red-50 text-red-600 font-bold px-3 py-2 rounded-lg hover:bg-red-100 transition"><i class="fa-solid fa-eraser mr-1"></i>è–¬ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button></div></div>
                <button onclick="saveSettings()" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-xl transition">è¨­å®šã‚’ä¿å­˜ã—ã¦æˆ»ã‚‹</button>
            </div>
            <div class="p-4 rounded-xl text-sm text-gray-500 text-center"><p>Â© 2024 Gastro Log v3.5</p></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-50 pb-safe">
        <div class="max-w-md mx-auto flex justify-around items-center h-16">
            <button onclick="switchView('analyze')" class="nav-btn active flex-1 flex flex-col items-center justify-center text-gray-400 transition"><i class="fa-solid fa-camera text-xl mb-1"></i><span class="text-xs font-bold">å…¥åŠ›ãƒ»è§£æ</span></button>
            <button onclick="switchView('history')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-400 transition"><i class="fa-solid fa-list-ul text-xl mb-1"></i><span class="text-xs font-bold">è¨˜éŒ²ãƒ»é›†è¨ˆ</span></button>
            <button onclick="switchView('settings')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-400 transition"><i class="fa-solid fa-gear text-xl mb-1"></i><span class="text-xs font-bold">è¨­å®š</span></button>
        </div>
    </nav>

    <script>
        let currentBase64 = null; let currentIngredients = []; let isManualModelMode = false;
        let currentYear = new Date().getFullYear(); let currentMonth = new Date().getMonth(); let currentViewMode = 'list'; let selectedDate = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            if(!localStorage.getItem('gemini_api_key')) { switchView('settings'); } else { updateNavStyles('analyze'); }
            checkAnalyzeable(); checkUrlParams(); loadMedicationHistory();
        });

        function updateStressDisplay(val) { document.getElementById('stressValueDisplay').textContent = val; }

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            let hasData = false;
            if (params.has('sleep')) { document.getElementById('sleepTime').value = params.get('sleep'); hasData = true; }
            if (params.has('quality')) { document.getElementById('sleepQuality').value = params.get('quality'); hasData = true; }
            if (params.has('steps')) { document.getElementById('stepsInput').value = params.get('steps'); hasData = true; }
            if (params.has('exercise')) { document.getElementById('exerciseInput').value = params.get('exercise'); hasData = true; }
            if (params.has('stress')) { const s = params.get('stress'); document.getElementById('stressInput').value = s; updateStressDisplay(s); hasData = true; }
            if (hasData) { document.getElementById('autoFillMessage').classList.remove('hidden'); window.history.replaceState({}, document.title, window.location.pathname); }
        }

        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            updateNavStyles(viewName); window.scrollTo(0, 0);
            const stickyTabs = document.getElementById('historyStickyTabs');
            if (viewName === 'history') {
                stickyTabs.classList.remove('hidden');
                if (currentViewMode === 'calendar') { renderCalendar(); renderHistory(selectedDate); } else { renderHistory(); }
                updateStats();
            } else { stickyTabs.classList.add('hidden'); }
        }
        function updateNavStyles(activeView) {
            const icons = { analyze: 0, history: 1, settings: 2 }; const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => btn.classList.remove('text-blue-600', 'text-gray-400')); navBtns.forEach(btn => btn.classList.add('text-gray-400'));
            if(navBtns[icons[activeView]]) { navBtns[icons[activeView]].classList.remove('text-gray-400'); navBtns[icons[activeView]].classList.add('text-blue-600'); }
        }

        function toggleHistoryView(mode) {
            currentViewMode = mode;
            const btnList = document.getElementById('btnViewList'); const btnCal = document.getElementById('btnViewCalendar');
            const calContainer = document.getElementById('calendarContainer'); const listTitle = document.getElementById('historyListTitle');
            if (mode === 'calendar') {
                btnList.classList.remove('bg-blue-600', 'text-white', 'shadow-sm'); btnList.classList.add('text-gray-500', 'hover:bg-gray-50');
                btnCal.classList.remove('text-gray-500', 'hover:bg-gray-50'); btnCal.classList.add('bg-blue-600', 'text-white', 'shadow-sm');
                calContainer.classList.remove('hidden'); renderCalendar(); renderHistory(selectedDate);
                listTitle.textContent = selectedDate ? `${selectedDate.getMonth()+1}/${selectedDate.getDate()} ã®ãƒ­ã‚°` : "ãƒ­ã‚°ä¸€è¦§";
            } else {
                btnCal.classList.remove('bg-blue-600', 'text-white', 'shadow-sm'); btnCal.classList.add('text-gray-500', 'hover:bg-gray-50');
                btnList.classList.remove('text-gray-500', 'hover:bg-gray-50'); btnList.classList.add('bg-blue-600', 'text-white', 'shadow-sm');
                calContainer.classList.add('hidden'); selectedDate = null; renderHistory(null); listTitle.textContent = "ãƒ­ã‚°ä¸€è¦§";
            }
        }
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid'); const title = document.getElementById('calendarTitle');
            grid.innerHTML = ''; title.textContent = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;
            const firstDay = new Date(currentYear, currentMonth, 1); const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate(); const startDayOfWeek = firstDay.getDay(); 
            const history = JSON.parse(localStorage.getItem('food_history') || '[]'); const today = new Date();
            for (let i = 0; i < startDayOfWeek; i++) { grid.appendChild(document.createElement('div')); }
            for (let d = 1; d <= daysInMonth; d++) {
                const dayDiv = document.createElement('div'); dayDiv.className = 'calendar-day'; dayDiv.textContent = d;
                const thisDate = new Date(currentYear, currentMonth, d);
                if (thisDate.toDateString() === today.toDateString()) dayDiv.classList.add('today');
                if (selectedDate && thisDate.toDateString() === selectedDate.toDateString()) dayDiv.classList.add('selected');
                const dayLogs = history.filter(item => { const logDate = new Date(item.id); return logDate.toDateString() === thisDate.toDateString(); });
                if (dayLogs.length > 0) {
                    const dot = document.createElement('div'); dot.className = 'dot';
                    const riskWords = ['é«˜FODMAP', 'é«˜è„‚è³ª', 'ã‚°ãƒ«ãƒ†ãƒ³', 'åˆºæ¿€ç‰©', 'ã‚«ãƒ•ã‚§ã‚¤ãƒ³', 'ä¹³ç³–'];
                    const hasWarning = dayLogs.some(item => item.ingredients && item.ingredients.some(ing => riskWords.some(r => ing.includes(r))));
                    const hasSafeFood = dayLogs.some(item => item.ingredients && item.ingredients.length > 0 && !item.ingredients.some(ing => riskWords.some(r => ing.includes(r))));
                    if (hasWarning) dot.classList.add('bg-red-500'); else if (hasSafeFood) dot.classList.add('bg-green-500'); else dot.classList.add('bg-blue-400');
                    dayDiv.appendChild(dot);
                }
                dayDiv.onclick = () => {
                    if (selectedDate && selectedDate.toDateString() === thisDate.toDateString()) selectedDate = null; else selectedDate = new Date(currentYear, currentMonth, d);
                    renderCalendar(); renderHistory(selectedDate);
                    const listTitle = document.getElementById('historyListTitle'); listTitle.textContent = selectedDate ? `${currentMonth + 1}/${d} ã®ãƒ­ã‚°` : "ãƒ­ã‚°ä¸€è¦§";
                };
                grid.appendChild(dayDiv);
            }
        }
        function changeMonth(delta) { currentMonth += delta; if (currentMonth > 11) { currentMonth = 0; currentYear++; } else if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(); }

        function renderHistory(filterDate = null) {
            const rawHistory = JSON.parse(localStorage.getItem('food_history') || '[]');
            const listContainer = document.getElementById('historyList'); listContainer.innerHTML = '';
            let history = rawHistory;
            if (filterDate) { history = rawHistory.filter(item => { const d = new Date(item.id); return d.toDateString() === filterDate.toDateString(); }); }
            if (history.length === 0) { listContainer.innerHTML = `<div class="text-center text-gray-400 py-10 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200"><i class="fa-solid fa-utensils text-3xl mb-2 opacity-50"></i><p class="text-sm">è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>`; return; }

            history.forEach(item => {
                const riskWords = ['é«˜FODMAP', 'é«˜è„‚è³ª', 'ã‚°ãƒ«ãƒ†ãƒ³', 'åˆºæ¿€ç‰©', 'ã‚«ãƒ•ã‚§ã‚¤ãƒ³', 'ä¹³ç³–'];
                const tagsHtml = item.ingredients && item.ingredients.length > 0 ? item.ingredients.map(t => {
                    let colorClass = 'bg-green-50 text-green-700 border-green-200';
                    if (riskWords.some(word => t.includes(word))) { colorClass = 'bg-red-100 text-red-700 border-red-200 font-bold'; }
                    return `<span class="${colorClass} text-xs px-2 py-0.5 rounded border mr-1 mb-1 inline-block">${t}</span>`;
                }).join('') : (item.image || (item.memo && !item.life) ? '<span class="text-xs text-gray-400"><i class="fa-solid fa-check mr-1"></i>æˆåˆ†ãªã—</span>' : '');

                let lifeLogHtml = ''; const life = item.life || {};
                if (life.sleepTime) { const qMap = { good: 'è‰¯', normal: 'æ™®', bad: 'æ‚ª' }; const qText = qMap[life.sleepQuality] ? `(${qMap[life.sleepQuality]})` : ''; lifeLogHtml += `<span class="text-xs text-indigo-600 bg-indigo-50 px-2 py-1 rounded mr-2 mb-1 inline-block"><i class="fa-solid fa-bed mr-1"></i>${life.sleepTime}h ${qText}</span>`; }
                if (life.steps) { lifeLogHtml += `<span class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded mr-2 mb-1 inline-block"><i class="fa-solid fa-shoe-prints mr-1"></i>${life.steps}æ­©</span>`; }
                if (life.stress) { const s = parseInt(life.stress); let color='bg-green-50 text-green-700'; if(s>=4)color='bg-yellow-50 text-yellow-700'; if(s>=8)color='bg-red-50 text-red-700'; lifeLogHtml += `<span class="text-xs ${color} px-2 py-1 rounded mr-2 mb-1 inline-block font-bold"><i class="fa-solid fa-bolt mr-1"></i>Lv.${s}</span>`; }
                if (life.exercise) { lifeLogHtml += `<span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded mr-2 mb-1 inline-block"><i class="fa-solid fa-person-running mr-1"></i>${life.exercise}</span>`; }
                if (life.medication) { lifeLogHtml += `<span class="text-xs text-teal-600 bg-teal-50 px-2 py-1 rounded mr-2 mb-1 inline-block"><i class="fa-solid fa-pills mr-1"></i>${life.medication}</span>`; }
                
                const imageHtml = item.image ? `<img src="${item.image}" class="w-20 h-20 object-cover rounded-lg bg-gray-200 border border-gray-100">` : `<div class="w-20 h-20 bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-center text-gray-300"><i class="fa-solid fa-notes-medical text-2xl"></i></div>`;
                const memoHtml = item.memo ? `<p class="text-xs text-gray-600 mt-2 bg-gray-50 p-2 rounded border border-gray-100"><i class="fa-regular fa-comment mr-1 text-gray-400"></i>${item.memo}</p>` : '';
                const html = `<div class="bg-white rounded-xl shadow-sm p-4 relative"><button onclick="deleteLog(${item.id})" class="absolute top-3 right-3 text-gray-300 hover:text-red-500 p-1"><i class="fa-solid fa-trash-can"></i></button><div class="flex gap-4 items-start mb-2">${imageHtml}<div class="flex-1 min-w-0 pt-1"><p class="text-xs text-gray-400 mb-1.5 flex items-center"><i class="fa-regular fa-clock mr-1"></i>${item.date}</p><div class="flex flex-wrap mb-2">${tagsHtml}</div><div class="flex flex-wrap gap-y-1">${lifeLogHtml}</div></div></div>${memoHtml}</div>`;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        async function analyze() {
            const apiKey = localStorage.getItem('gemini_api_key'); const model = localStorage.getItem('gemini_model') || 'gemini-2.5-flash'; const textMemo = document.getElementById('textInput').value.trim();
            if (!apiKey) { alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'); switchView('settings'); return; }
            document.getElementById('loadingArea').classList.remove('hidden'); document.getElementById('actionButtons').classList.add('hidden'); document.getElementById('resultArea').classList.add('hidden');
            const systemPrompt = `ã‚ãªãŸã¯æ¶ˆåŒ–å™¨å†…ç§‘ã®å°‚é–€çŸ¥è­˜ã‚’æŒã¤ç®¡ç†æ „é¤Šå£«ã§ã™ã€‚æä¾›ã•ã‚ŒãŸæ–™ç†ã®ç”»åƒã‚„ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€ä½¿ã‚ã‚Œã¦ã„ã‚‹ã€ã™ã¹ã¦ã®é£Ÿæã€‘ã‚’å…·ä½“çš„ã«æ¨æ¸¬ã—ã¦ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚å„é£Ÿæã«ã¤ã„ã¦ã€IBSï¼ˆéæ•æ€§è…¸ç—‡å€™ç¾¤ï¼‰ã®è¦³ç‚¹ã‹ã‚‰ä»¥ä¸‹ã®ã‚¿ã‚°ã‚’æœ«å°¾ã«ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚- é«˜FODMAPé£Ÿæã®å ´åˆ: "(é«˜FODMAP)" - è„‚è³ªãŒå¤šã„é£Ÿæã®å ´åˆ: "(é«˜è„‚è³ª)" - ã‚°ãƒ«ãƒ†ãƒ³ã‚’å«ã‚€å ´åˆ: "(ã‚°ãƒ«ãƒ†ãƒ³)" - è¾›å‘³æˆåˆ†ãªã©åˆºæ¿€ãŒå¼·ã„å ´åˆ: "(åˆºæ¿€ç‰©)" - ã‚«ãƒ•ã‚§ã‚¤ãƒ³ã‚’å«ã‚€å ´åˆ: "(ã‚«ãƒ•ã‚§ã‚¤ãƒ³)" - å•é¡Œãªã„é£Ÿæ: ã‚¿ã‚°ãªã—ã€‚å›ç­”ã¯å¿…ãš JSONå½¢å¼ã®é…åˆ— ["é£Ÿæå (ã‚¿ã‚°)", "é£Ÿæå"] ã ã‘ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;
            let requestParts = [{ text: systemPrompt }]; if (textMemo) requestParts.push({ text: `ã€è£œè¶³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã€‘\n${textMemo}` }); if (currentBase64) requestParts.push({ inline_data: { mime_type: "image/jpeg", data: currentBase64.split(',')[1] } });
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            try { const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: requestParts }] }) }); if (!response.ok) { throw new Error(`API Error: ${response.status}`); } const data = await response.json(); const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text; if (!rawText) throw new Error('å¿œç­”ãªã—'); const jsonStr = rawText.replace(/```json|```/g, '').trim(); try { currentIngredients = JSON.parse(jsonStr); } catch (e) { currentIngredients = []; } displayResults(currentIngredients); } catch (error) { console.error(error); alert(`è§£æã‚¨ãƒ©ãƒ¼:\n${error.message}`); document.getElementById('actionButtons').classList.remove('hidden'); } finally { document.getElementById('loadingArea').classList.add('hidden'); }
        }

        // --- â˜…ä¿®æ­£: å‰Šé™¤æ©Ÿèƒ½ ---
        function displayResults(ingredients) { 
            const container = document.getElementById('tagsContainer'); container.innerHTML = ''; 
            if (!ingredients || ingredients.length === 0) { container.innerHTML = '<span class="text-gray-500 text-sm">ç‰¹ã«ãªã—</span>'; } 
            else { 
                const riskWords = ['é«˜FODMAP', 'é«˜è„‚è³ª', 'ã‚°ãƒ«ãƒ†ãƒ³', 'åˆºæ¿€ç‰©', 'ã‚«ãƒ•ã‚§ã‚¤ãƒ³'];
                ingredients.forEach((tag, index) => { // indexã‚’å—ã‘å–ã‚‹
                    const span = document.createElement('span'); 
                    let colorClass = 'bg-green-50 text-green-700 border-green-200';
                    if (riskWords.some(word => tag.includes(word))) { colorClass = 'bg-red-100 text-red-700 border-red-200 font-bold'; }
                    span.className = `${colorClass} text-sm px-3 py-1 rounded-full border tag-removable`; // ã‚¯ãƒ©ã‚¹è¿½åŠ 
                    span.textContent = tag; 
                    // ã‚¿ãƒƒãƒ—ã§å‰Šé™¤ (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŒ‡å®š)
                    span.onclick = function() { removeIngredient(index); };
                    container.appendChild(span); 
                }); 
            } 
            document.getElementById('resultArea').classList.remove('hidden'); 
        }

        // --- â˜…æ–°æ©Ÿèƒ½: ã‚¿ã‚°å‰Šé™¤ ---
        function removeIngredient(index) {
            if (index > -1) {
                currentIngredients.splice(index, 1); // é…åˆ—ã‹ã‚‰å‰Šé™¤
                displayResults(currentIngredients); // å†æç”»
            }
        }

        function loadMedicationHistory() { const list = JSON.parse(localStorage.getItem('medication_history') || '[]'); const datalist = document.getElementById('medicationHistoryList'); datalist.innerHTML = ''; list.forEach(item => { const option = document.createElement('option'); option.value = item; datalist.appendChild(option); }); }
        function addToMedicationHistory(text) { if(!text) return; let list = JSON.parse(localStorage.getItem('medication_history') || '[]'); if (!list.includes(text)) { list.push(text); localStorage.setItem('medication_history', JSON.stringify(list)); loadMedicationHistory(); } }
        function clearMedicationHistory() { if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; localStorage.removeItem('medication_history'); loadMedicationHistory(); }
        function saveSettings() { const key = document.getElementById('apiKeyInput').value.trim(); let model; if (isManualModelMode) model = document.getElementById('modelInput').value.trim(); else model = document.getElementById('modelSelect').value; if(!key || !model) { alert('æœªå…¥åŠ›ã§ã™'); return; } localStorage.setItem('gemini_api_key', key); localStorage.setItem('gemini_model', model); alert('ä¿å­˜ã—ã¾ã—ãŸ'); switchView('analyze'); }
        function loadSettings() { const key = localStorage.getItem('gemini_api_key'); const model = localStorage.getItem('gemini_model'); if(key) document.getElementById('apiKeyInput').value = key; if (model) { const select = document.getElementById('modelSelect'); const optionExists = Array.from(select.options).some(opt => opt.value === model); if (optionExists) select.value = model; else { toggleModelInputMode(true); document.getElementById('modelInput').value = model; } } else { document.getElementById('modelSelect').value = "gemini-2.5-flash"; } }
        function toggleModelInputMode(forceManual = null) { const selectContainer = document.getElementById('modelSelectContainer'); const inputContainer = document.getElementById('modelInputContainer'); if (forceManual === null) isManualModelMode = !isManualModelMode; else isManualModelMode = forceManual; if (isManualModelMode) { selectContainer.classList.add('hidden'); inputContainer.classList.remove('hidden'); } else { selectContainer.classList.remove('hidden'); inputContainer.classList.add('hidden'); } }
        async function fetchModels() { const apiKey = document.getElementById('apiKeyInput').value.trim(); const statusEl = document.getElementById('modelFetchStatus'); const selectEl = document.getElementById('modelSelect'); const btn = document.getElementById('fetchModelsBtn'); if (!apiKey) { alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; } statusEl.textContent = 'å–å¾—ä¸­(v1beta)...'; statusEl.className = 'text-xs text-blue-500 mt-2 animate-pulse'; btn.disabled = true; try { const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`; const res = await fetch(url); if(!res.ok) throw new Error(`Error: ${res.status}`); const data = await res.json(); const availableModels = data.models.filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent")).map(m => m.name.replace('models/', '')).sort(); selectEl.innerHTML = ''; availableModels.forEach(modelName => { const option = document.createElement('option'); option.value = modelName; option.textContent = modelName; if(modelName.includes('gemini-3')||modelName.includes('pro-preview')) option.textContent+=' ğŸš€'; else if(modelName.includes('flash')) option.textContent+=' âš¡'; selectEl.appendChild(option); }); const best = availableModels.find(m => m.includes('2.5-flash')) || availableModels[0]; selectEl.value = best; if (isManualModelMode) toggleModelInputMode(false); statusEl.textContent = `å®Œäº†: ${availableModels.length}ä»¶`; statusEl.className = 'text-xs text-green-600 mt-2'; } catch (e) { console.error(e); statusEl.textContent = 'å¤±æ•—'; statusEl.className = 'text-xs text-red-500 mt-2'; alert('å–å¾—å¤±æ•—'); } finally { btn.disabled = false; } }
        function handleImageSelect(event) { const file = event.target.files[0]; if (!file) return; resizeImage(file).then(resizedBase64 => { currentBase64 = resizedBase64; const imgEl = document.getElementById('previewImage'); imgEl.src = currentBase64; imgEl.classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); document.getElementById('removeImageBtn').classList.remove('hidden'); document.getElementById('imageUploadLabel').classList.add('border-blue-500'); checkAnalyzeable(); document.getElementById('resultArea').classList.add('hidden'); }); event.target.value = ''; }
        function removeImage(event) { event.preventDefault(); currentBase64 = null; document.getElementById('previewImage').src = ''; document.getElementById('previewImage').classList.add('hidden'); document.getElementById('uploadPlaceholder').classList.remove('hidden'); document.getElementById('removeImageBtn').classList.add('hidden'); document.getElementById('imageUploadLabel').classList.remove('border-blue-500'); checkAnalyzeable(); }
        function checkAnalyzeable() { const text = document.getElementById('textInput').value.trim(); document.getElementById('analyzeBtn').disabled = !(currentBase64 || text.length > 0); }
        function resizeImage(file, maxWidth = 800) { return new Promise((resolve) => { const img = new Image(); img.src = URL.createObjectURL(file); img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height; if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; } canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', 0.7)); }; }); }
        function saveLog(isAnalyzed) { if (!isAnalyzed) currentIngredients = []; const sleepTime = document.getElementById('sleepTime').value; const sleepQuality = document.getElementById('sleepQuality').value; const medication = document.getElementById('medicationInput').value.trim(); const exercise = document.getElementById('exerciseInput').value.trim(); const steps = document.getElementById('stepsInput').value; const stress = document.getElementById('stressInput').value; const textMemo = document.getElementById('textInput').value.trim(); if (!currentBase64 && !textMemo && !sleepTime && !medication && !exercise && !steps) { alert('è¨˜éŒ²å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“'); return; } if (medication) addToMedicationHistory(medication); const newLog = { id: Date.now(), date: new Date().toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute:'2-digit' }), image: currentBase64, memo: textMemo, ingredients: currentIngredients, life: { sleepTime, sleepQuality, medication, exercise, steps, stress } }; let history = JSON.parse(localStorage.getItem('food_history') || '[]'); history.unshift(newLog); history = history.slice(0, 50); try { localStorage.setItem('food_history', JSON.stringify(history)); alert('è¨˜éŒ²ã—ã¾ã—ãŸ'); resetAnalyzeView(); switchView('history'); } catch (e) { alert('å®¹é‡ä¸Šé™ã§ã™ã€‚å¤ã„å±¥æ­´ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚'); } }
        function resetAnalyzeView() { currentBase64 = null; currentIngredients = []; document.getElementById('textInput').value = ''; document.getElementById('sleepTime').value = ''; document.getElementById('sleepQuality').value = ''; document.getElementById('medicationInput').value = ''; document.getElementById('exerciseInput').value = ''; document.getElementById('stepsInput').value = ''; document.getElementById('stressInput').value = 5; updateStressDisplay(5); removeImage(new Event('click')); document.getElementById('actionButtons').classList.remove('hidden'); document.getElementById('analyzeBtn').disabled = true; document.getElementById('resultArea').classList.add('hidden'); document.getElementById('autoFillMessage').classList.add('hidden'); }
        function deleteLog(id) { if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; let history = JSON.parse(localStorage.getItem('food_history') || '[]'); history = history.filter(item => item.id !== id); localStorage.setItem('food_history', JSON.stringify(history)); renderCalendar(); renderHistory(selectedDate); updateStats(); }
        function clearAllData() { if(!confirm('å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; localStorage.removeItem('food_history'); renderCalendar(); renderHistory(null); updateStats(); }
        function updateStats() { const history = JSON.parse(localStorage.getItem('food_history') || '[]'); const statsContainer = document.getElementById('statsContainer'); statsContainer.innerHTML = ''; if (history.length === 0) { statsContainer.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</p>'; return; } const counts = {}; let totalDetected = 0; history.forEach(item => { if(item.ingredients) { item.ingredients.forEach(ing => { counts[ing] = (counts[ing] || 0) + 1; totalDetected++; }); } }); if(totalDetected === 0) { statsContainer.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">æ³¨æ„æˆåˆ†ãªã—</p>'; return; } const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5); const maxCount = sorted[0][1]; const colors = ['bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 'bg-lime-500']; sorted.forEach(([name, count], index) => { const percentage = (count / maxCount) * 100; const barColor = colors[index % colors.length]; const html = `<div class="flex items-center justify-between text-sm mb-2"><span class="w-32 truncate font-bold text-gray-700" title="${name}">${name}</span><div class="flex-1 h-2.5 bg-gray-100 rounded-full overflow-hidden mx-3 relative"><div class="h-full ${barColor} rounded-full relative" style="width: ${percentage}%"></div></div><span class="text-gray-500 font-mono text-xs">${count}å›</span></div>`; statsContainer.insertAdjacentHTML('beforeend', html); }); }
    </script>
</body>
</html>