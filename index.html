<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gastro Log (Gemini AI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        main { padding-top: 70px; padding-bottom: 80px; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 font-sans antialiased">

    <header class="bg-white shadow-sm fixed top-0 left-0 w-full z-50">
        <div class="max-w-md mx-auto px-4 h-16 flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-600 flex items-center"><i class="fa-solid fa-notes-medical mr-2"></i>Gastro Log</h1>
            <button onclick="clearAllData()" class="text-xs text-gray-400 hover:text-red-600 flex items-center">
                <i class="fa-solid fa-trash mr-1"></i> å±¥æ­´å‰Šé™¤
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 min-h-screen">
        <section id="view-analyze" class="view-section active">
            <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
                <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4">é£Ÿäº‹ã®å…¥åŠ›</h2>
                <div class="mb-4">
                    <label for="cameraInput" id="imageUploadLabel" class="cursor-pointer block w-full h-48 border-2 border-dashed border-blue-200 rounded-xl flex flex-col justify-center items-center hover:bg-blue-50 transition relative overflow-hidden bg-gray-50">
                        <div id="uploadPlaceholder" class="flex flex-col items-center text-gray-400">
                            <i class="fa-solid fa-camera text-3xl mb-2"></i><span class="text-xs">å†™çœŸã‚’æ’®å½±ãƒ»é¸æŠ</span>
                        </div>
                        <img id="previewImage" class="hidden absolute inset-0 w-full h-full object-cover" />
                        <button id="removeImageBtn" onclick="removeImage(event)" class="hidden absolute top-2 right-2 bg-gray-800 bg-opacity-60 text-white rounded-full w-8 h-8 flex items-center justify-center z-10 hover:bg-red-600 transition"><i class="fa-solid fa-xmark"></i></button>
                    </label>
                    <input type="file" id="cameraInput" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                </div>
                <div class="mb-4 relative">
                    <textarea id="textInput" rows="3" placeholder="è£œè¶³ãƒ¡ãƒ¢ï¼ˆä¾‹: ãƒ©ãƒ¼ãƒ¡ãƒ³å‘³æ¿ƒã„ã‚ã€è„‚å¤šã‚ï¼‰" class="w-full p-3 border border-gray-200 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-gray-50" oninput="checkAnalyzeable()"></textarea>
                    <i class="fa-solid fa-pen absolute top-3 right-3 text-gray-300"></i>
                </div>
                <div id="loadingArea" class="hidden flex flex-col items-center justify-center py-6 bg-blue-50 rounded-xl mb-4">
                    <div class="loader mb-3"></div><p class="text-sm text-blue-600 font-bold animate-pulse">AIãŒæˆåˆ†ã‚’è§£æã—ã¦ã„ã¾ã™...</p>
                </div>
                <button id="analyzeBtn" onclick="analyze()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center" disabled>
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>è§£æã™ã‚‹
                </button>
            </div>
            <div id="resultArea" class="hidden bg-white rounded-xl shadow-sm border-l-4 border-green-500 overflow-hidden">
                <div class="p-5">
                    <h3 class="font-bold text-lg mb-3 flex items-center"><i class="fa-solid fa-circle-check text-green-500 mr-2"></i>è§£æçµæœ</h3>
                    <div id="tagsContainer" class="flex flex-wrap gap-2 mb-5"></div>
                    <button onclick="saveLog()" class="w-full bg-green-50 hover:bg-green-100 text-green-700 font-bold py-3 px-4 rounded-xl flex items-center justify-center transition"><i class="fa-solid fa-floppy-disk mr-2"></i>ã“ã®çµæœã‚’è¨˜éŒ²</button>
                </div>
            </div>
        </section>

        <section id="view-history" class="view-section">
            <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
                <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4 flex items-center"><i class="fa-solid fa-chart-simple mr-2"></i>æˆåˆ†ãƒ©ãƒ³ã‚­ãƒ³ã‚° (TOP 5)</h2>
                <div id="statsContainer" class="space-y-3"></div>
            </div>
            <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4 pl-2">é£Ÿäº‹ãƒ­ã‚°</h2>
            <div id="historyList" class="space-y-4"></div>
        </section>

        <section id="view-settings" class="view-section">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h2 class="text-xl font-bold mb-6 flex items-center"><i class="fa-solid fa-sliders mr-2"></i>è¨­å®š</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-bold mb-2 text-gray-700">Gemini API Key <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10">
                        <i class="fa-solid fa-key absolute top-3.5 right-3 text-gray-300"></i>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">APIã‚­ãƒ¼ã‚’å…¥åŠ›å¾Œã€ä¸‹ã®ã€Œãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’æ›´æ–°ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <div class="mb-8">
                    <label class="block text-sm font-bold mb-2 text-gray-700">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</label>
                    
                    <div id="modelSelectContainer" class="relative mb-2">
                        <select id="modelSelect" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
                            <option value="gemini-2.5-flash">gemini-2.5-flash (æ¨å¥¨)</option>
                            <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                            <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute top-4 right-4 text-gray-400 pointer-events-none"></i>
                    </div>

                    <div id="modelInputContainer" class="relative mb-2 hidden">
                        <input type="text" id="modelInput" placeholder="ãƒ¢ãƒ‡ãƒ«åã‚’æ‰‹å…¥åŠ›" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fa-solid fa-robot absolute top-3.5 right-3 text-gray-300"></i>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="fetchModels()" id="fetchModelsBtn" class="flex-1 text-xs bg-blue-50 text-blue-700 font-bold px-3 py-2.5 rounded-lg hover:bg-blue-100 transition flex items-center justify-center">
                            <i class="fa-solid fa-cloud-arrow-down mr-1"></i>ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                        </button>
                        <button onclick="toggleModelInputMode()" class="text-xs bg-gray-100 text-gray-500 font-bold px-3 py-2.5 rounded-lg hover:bg-gray-200 transition">
                            <i class="fa-solid fa-pen mr-1"></i>æ‰‹å…¥åŠ›
                        </button>
                    </div>
                    
                    <p id="modelFetchStatus" class="text-xs text-gray-400 mt-2 h-4"></p>
                </div>

                <button onclick="saveSettings()" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-xl transition">
                    è¨­å®šã‚’ä¿å­˜ã—ã¦æˆ»ã‚‹
                </button>
            </div>
            <div class="p-4 rounded-xl text-sm text-gray-500 text-center"><p>Â© 2024 Gastro Log v1.3</p></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-50 pb-safe">
        <div class="max-w-md mx-auto flex justify-around items-center h-16">
            <button onclick="switchView('analyze')" class="nav-btn active flex-1 flex flex-col items-center justify-center text-gray-400 transition"><i class="fa-solid fa-camera text-xl mb-1"></i><span class="text-xs font-bold">å…¥åŠ›ãƒ»è§£æ</span></button>
            <button onclick="switchView('history')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-400 transition"><i class="fa-solid fa-list-ul text-xl mb-1"></i><span class="text-xs font-bold">è¨˜éŒ²ãƒ»é›†è¨ˆ</span></button>
            <button onclick="switchView('settings')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-400 transition"><i class="fa-solid fa-gear text-xl mb-1"></i><span class="text-xs font-bold">è¨­å®š</span></button>
        </div>
    </nav>

    <script>
        let currentBase64 = null;
        let currentIngredients = [];
        let isManualModelMode = false;
        
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            if(!localStorage.getItem('gemini_api_key')) { switchView('settings'); } else { updateNavStyles('analyze'); }
            checkAnalyzeable();
        });

        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            updateNavStyles(viewName);
            window.scrollTo(0, 0);
            if(viewName === 'history') { renderHistory(); updateStats(); }
        }

        function updateNavStyles(activeView) {
            const icons = { analyze: 0, history: 1, settings: 2 };
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => btn.classList.remove('text-blue-600', 'text-gray-400'));
            navBtns.forEach(btn => btn.classList.add('text-gray-400'));
            if(navBtns[icons[activeView]]) { navBtns[icons[activeView]].classList.remove('text-gray-400'); navBtns[icons[activeView]].classList.add('text-blue-600'); }
        }

        // --- è¨­å®šé–¢é€£ ---
        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ä¿å­˜ã™ã‚‹å€¤ã‚’å¤‰ãˆã‚‹
            let model;
            if (isManualModelMode) {
                model = document.getElementById('modelInput').value.trim();
            } else {
                model = document.getElementById('modelSelect').value;
            }

            if(!key) { alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if(!model) { alert('ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('gemini_model', model);
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            switchView('analyze');
        }

        function loadSettings() {
            const key = localStorage.getItem('gemini_api_key');
            const model = localStorage.getItem('gemini_model'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãªã—ã€‚ä¿å­˜å€¤ã‚’å°Šé‡
            
            if(key) document.getElementById('apiKeyInput').value = key;

            // ä¿å­˜ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚‹å ´åˆã€selectã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ã‚»ãƒƒãƒˆ
            if (model) {
                const select = document.getElementById('modelSelect');
                const optionExists = Array.from(select.options).some(opt => opt.value === model);
                
                if (optionExists) {
                    select.value = model;
                } else {
                    // selectã«ãªã„ã®ã§æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã¨ã—ã¦æ‰±ã†ï¼ˆã‚ã‚‹ã„ã¯Optionã‚’è¿½åŠ ã™ã‚‹ï¼‰
                    // ã“ã“ã§ã¯æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¦å€¤ã‚’ã‚»ãƒƒãƒˆ
                    toggleModelInputMode(true);
                    document.getElementById('modelInput').value = model;
                }
            } else {
                // åˆå›èµ·å‹•æ™‚ãªã©
                document.getElementById('modelSelect').value = "gemini-2.5-flash"; 
            }
        }

        // --- ãƒ¢ãƒ‡ãƒ«ä¸€è¦§å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ (v1betaå¯¾å¿œç‰ˆ) ---
        async function fetchModels() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const statusEl = document.getElementById('modelFetchStatus');
            const selectEl = document.getElementById('modelSelect');
            const btn = document.getElementById('fetchModelsBtn');

            if (!apiKey) { alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            statusEl.textContent = 'æœ€æ–°ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’å–å¾—ä¸­(v1beta)...';
            statusEl.className = 'text-xs text-blue-500 mt-2 animate-pulse';
            btn.disabled = true;

            try {
                // â˜…ã“ã“ã‚’ v1 ã‹ã‚‰ v1beta ã«å¤‰æ›´ã—ã¾ã—ãŸ
                const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
                const res = await fetch(url);
                
                if(!res.ok) {
                    throw new Error(`Error: ${res.status}`);
                }

                const data = await res.json();
                
                const availableModels = data.models
                    .filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent"))
                    .map(m => m.name.replace('models/', ''))
                    .sort();

                if (availableModels.length === 0) {
                    throw new Error('åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }

                selectEl.innerHTML = '';
                availableModels.forEach(modelName => {
                    const option = document.createElement('option');
                    option.value = modelName;
                    option.textContent = modelName;
                    
                    // æœ€æ–°ãƒ»é«˜æ€§èƒ½ãƒ¢ãƒ‡ãƒ«ã‚’ç›®ç«‹ãŸã›ã‚‹
                    if(modelName.includes('gemini-3') || modelName.includes('pro-preview')) {
                        option.textContent += ' ğŸš€(New)'; 
                    } else if(modelName.includes('flash') && !modelName.includes('legacy')) {
                        option.textContent += ' âš¡'; 
                    }
                    selectEl.appendChild(option);
                });

                // gemini-3ç³»ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æ–°ã—ã„Flashã‚’é¸æŠ
                const bestModel = availableModels.find(m => m.includes('gemini-3')) || availableModels.find(m => m.includes('2.5-flash')) || availableModels[0];
                selectEl.value = bestModel;

                if (isManualModelMode) toggleModelInputMode(false);
                statusEl.textContent = `å–å¾—æˆåŠŸ! ${availableModels.length}å€‹ã®ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ(v1beta)`;
                statusEl.className = 'text-xs text-green-600 mt-2';

            } catch (e) {
                console.error(e);
                statusEl.textContent = `å–å¾—å¤±æ•—: ${e.message}`;
                statusEl.className = 'text-xs text-red-500 mt-2';
                alert('ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            } finally {
                btn.disabled = false;
            }
        }
                
        function toggleModelInputMode(forceManual = null) {
            const selectContainer = document.getElementById('modelSelectContainer');
            const inputContainer = document.getElementById('modelInputContainer');
            
            // å¼•æ•°ãŒãªã‘ã‚Œã°ãƒˆã‚°ãƒ«
            if (forceManual === null) {
                isManualModelMode = !isManualModelMode;
            } else {
                isManualModelMode = forceManual;
            }

            if (isManualModelMode) {
                selectContainer.classList.add('hidden');
                inputContainer.classList.remove('hidden');
            } else {
                selectContainer.classList.remove('hidden');
                inputContainer.classList.add('hidden');
            }
        }

        // --- å…¥åŠ›å‡¦ç† ---
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            resizeImage(file).then(resizedBase64 => {
                currentBase64 = resizedBase64;
                const imgEl = document.getElementById('previewImage');
                imgEl.src = currentBase64;
                imgEl.classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('removeImageBtn').classList.remove('hidden');
                document.getElementById('imageUploadLabel').classList.add('border-blue-500');
                checkAnalyzeable();
                document.getElementById('resultArea').classList.add('hidden');
            });
            event.target.value = '';
        }

        function removeImage(event) {
            event.preventDefault();
            currentBase64 = null;
            document.getElementById('previewImage').src = '';
            document.getElementById('previewImage').classList.add('hidden');
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('removeImageBtn').classList.add('hidden');
            document.getElementById('imageUploadLabel').classList.remove('border-blue-500');
            checkAnalyzeable();
        }

        function checkAnalyzeable() {
            const text = document.getElementById('textInput').value.trim();
            document.getElementById('analyzeBtn').disabled = !(currentBase64 || text.length > 0);
        }

        function resizeImage(file, maxWidth = 800) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            });
        }

// --- APIè§£æ (v1betaå¯¾å¿œç‰ˆ) ---
        async function analyze() {
            const apiKey = localStorage.getItem('gemini_api_key');
            const model = localStorage.getItem('gemini_model') || 'gemini-2.5-flash';
            const textMemo = document.getElementById('textInput').value.trim();

            if (!apiKey) { alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); switchView('settings'); return; }

            document.getElementById('loadingArea').classList.remove('hidden');
            document.getElementById('analyzeBtn').classList.add('hidden');
            document.getElementById('resultArea').classList.add('hidden');

            const systemPrompt = `
                ã‚ãªãŸã¯æ¶ˆåŒ–å™¨å†…ç§‘ã®å°‚é–€çŸ¥è­˜ã‚’æŒã¤æ „é¤Šå£«ã§ã™ã€‚
                æä¾›ã•ã‚ŒãŸæ–™ç†ã®ç”»åƒã€ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ï¼ˆã‚ã‚‹ã„ã¯ãã®ä¸¡æ–¹ï¼‰ã‚’è§£æã—ã€èƒƒè…¸ã«è² æ‹…ã‚’ã‹ã‘ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹æˆåˆ†ã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚
                å¯¾è±¡ã¨ãªã‚‹æˆåˆ†ã®ä¾‹ï¼šè„‚è³ªã€ã‚«ãƒ—ã‚µã‚¤ã‚·ãƒ³ï¼ˆè¾›å‘³æˆåˆ†ï¼‰ã€ä¹³ç³–ã€ã‚°ãƒ«ãƒ†ãƒ³ã€ã‚«ãƒ•ã‚§ã‚¤ãƒ³ã€é«˜FODMAPé£Ÿæã€å¼·ã„é…¸å‘³ã€æ¶ˆåŒ–ã®æ‚ªã„ç¹Šç¶­è³ªãªã©ã€‚
                å›ç­”ã¯å¿…ãšä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®é…åˆ—ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚„è¿½åŠ ã®èª¬æ˜ã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚
                ["æˆåˆ†A", "æˆåˆ†B", "æˆåˆ†C"]
                ã‚‚ã—ç‰¹ã«è©²å½“ã™ã‚‹æˆåˆ†ãŒãªã‘ã‚Œã°ç©ºã®é…åˆ— [] ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
            `;

            let requestParts = [{ text: systemPrompt }];
            if (textMemo) requestParts.push({ text: `ã€è£œè¶³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã€‘\n${textMemo}` });
            if (currentBase64) requestParts.push({ inline_data: { mime_type: "image/jpeg", data: currentBase64.split(',')[1] } });

            // â˜…ã“ã“ã‚’ v1 ã‹ã‚‰ v1beta ã«å¤‰æ›´ã—ã¾ã—ãŸ
            // (v1betaã¯é€šå¸¸ã®v1ãƒ¢ãƒ‡ãƒ«ã‚‚å¤§æŠµã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãŸã‚ã€å…¨ä½“ã‚’betaã«åˆ‡ã‚Šæ›¿ãˆã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“)
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: requestParts }] })
                });

                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('ä½¿ã„ã™ãã§ã™(ãƒ¬ãƒ¼ãƒˆåˆ¶é™)ã€‚\nç„¡æ–™æ ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚æ•°åˆ†å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    }
                    if (response.status === 503) {
                        throw new Error('ã‚µãƒ¼ãƒãƒ¼ãŒæ··é›‘ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
                    }
                    const errData = await response.json();
                    throw new Error(errData.error?.message || `API Error: ${response.status}`);
                }

                const data = await response.json();
                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!rawText) throw new Error('Geminiã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã—ãŸã€‚');

                const jsonStr = rawText.replace(/```json|```/g, '').trim();
                try {
                    currentIngredients = JSON.parse(jsonStr);
                } catch (e) {
                     console.error("JSON Parse Error. Raw text:", rawText);
                     currentIngredients = []; 
                     alert("è§£æçµæœã®å½¢å¼ãŒä¸æ­£ã§ã—ãŸã€‚");
                }
                displayResults(currentIngredients);

            } catch (error) {
                console.error(error);
                alert(`è§£æã‚¨ãƒ©ãƒ¼:\n${error.message}`);
                document.getElementById('analyzeBtn').classList.remove('hidden');
            } finally {
                document.getElementById('loadingArea').classList.add('hidden');
            }
        }
        
        function displayResults(ingredients) {
            const container = document.getElementById('tagsContainer');
            container.innerHTML = '';
            if (!ingredients || ingredients.length === 0) {
                container.innerHTML = '<span class="text-gray-500 text-sm flex items-center"><i class="fa-regular fa-face-smile mr-1"></i>ç‰¹ã«ãªã— (èƒƒè…¸ã«å„ªã—ã„å¯èƒ½æ€§ãŒé«˜ã„ã§ã™)</span>';
            } else {
                ingredients.forEach(tag => {
                    const tagName = tag.length > 15 ? tag.substring(0,15) + '...' : tag;
                    const span = document.createElement('span');
                    span.className = 'bg-red-100 text-red-700 text-sm font-semibold px-3 py-1 rounded-full border border-red-200';
                    span.textContent = tagName;
                    container.appendChild(span);
                });
            }
            document.getElementById('resultArea').classList.remove('hidden');
        }

        function saveLog() {
            if (!currentBase64 && !document.getElementById('textInput').value.trim() && currentIngredients.length === 0) return;
            const newLog = {
                id: Date.now(),
                date: new Date().toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute:'2-digit' }),
                image: currentBase64,
                memo: document.getElementById('textInput').value.trim(),
                ingredients: currentIngredients
            };
            let history = JSON.parse(localStorage.getItem('food_history') || '[]');
            history.unshift(newLog);
            history = history.slice(0, 50);
            try {
                localStorage.setItem('food_history', JSON.stringify(history));
                alert('è¨˜éŒ²ã—ã¾ã—ãŸ');
                resetAnalyzeView();
                switchView('history');
            } catch (e) { alert('ä¿å­˜å®¹é‡ã®ä¸Šé™ã§ã™ã€‚å¤ã„å±¥æ­´ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚'); }
        }

        function resetAnalyzeView() {
            currentBase64 = null;
            currentIngredients = [];
            document.getElementById('textInput').value = '';
            removeImage(new Event('click'));
            document.getElementById('analyzeBtn').classList.remove('hidden');
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('resultArea').classList.add('hidden');
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('food_history') || '[]');
            const listContainer = document.getElementById('historyList');
            listContainer.innerHTML = '';
            if (history.length === 0) {
                listContainer.innerHTML = `<div class="text-center text-gray-400 py-10 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200"><i class="fa-solid fa-utensils text-3xl mb-2 opacity-50"></i><p class="text-sm">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
                return;
            }
            history.forEach(item => {
                const tagsHtml = item.ingredients && item.ingredients.length > 0 
                    ? item.ingredients.map(t => `<span class="bg-red-50 text-red-600 text-xs px-2 py-0.5 rounded border border-red-100">${t}</span>`).join('')
                    : '<span class="text-xs text-green-600"><i class="fa-solid fa-check mr-1"></i>æ³¨æ„æˆåˆ†ãªã—</span>';
                const imageHtml = item.image 
                    ? `<img src="${item.image}" class="w-20 h-20 object-cover rounded-lg bg-gray-200 border border-gray-100">`
                    : `<div class="w-20 h-20 bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-center text-gray-300"><i class="fa-solid fa-comment-dots text-2xl"></i></div>`;
                const memoHtml = item.memo 
                    ? `<p class="text-xs text-gray-600 mt-2 bg-gray-50 p-2 rounded border border-gray-100"><i class="fa-regular fa-comment mr-1 text-gray-400"></i>${item.memo}</p>` : '';
                const html = `
                    <div class="bg-white rounded-xl shadow-sm p-4 relative">
                        <button onclick="deleteLog(${item.id})" class="absolute top-3 right-3 text-gray-300 hover:text-red-500 p-1"><i class="fa-solid fa-trash-can"></i></button>
                        <div class="flex gap-4 items-start mb-2">
                            ${imageHtml}
                            <div class="flex-1 min-w-0 pt-1">
                                <p class="text-xs text-gray-400 mb-1.5 flex items-center"><i class="fa-regular fa-clock mr-1"></i>${item.date}</p>
                                <div class="flex flex-wrap gap-1.5">${tagsHtml}</div>
                            </div>
                        </div>
                        ${memoHtml}
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        function deleteLog(id) {
            if(!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            let history = JSON.parse(localStorage.getItem('food_history') || '[]');
            history = history.filter(item => item.id !== id);
            localStorage.setItem('food_history', JSON.stringify(history));
            renderHistory();
            updateStats();
        }

        function clearAllData() {
            if(!confirm('ã™ã¹ã¦ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(APIã‚­ãƒ¼ã®è¨­å®šã¯æ®‹ã‚Šã¾ã™)')) return;
            localStorage.removeItem('food_history');
            renderHistory();
            updateStats();
        }

        function updateStats() {
            const history = JSON.parse(localStorage.getItem('food_history') || '[]');
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = '';
            if (history.length === 0) { statsContainer.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ãƒ‡ãƒ¼ã‚¿ãŒé›†ã¾ã‚‹ã¨ã“ã“ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>'; return; }
            const counts = {};
            let totalDetected = 0;
            history.forEach(item => { if(item.ingredients) { item.ingredients.forEach(ing => { counts[ing] = (counts[ing] || 0) + 1; totalDetected++; }); } });
            if(totalDetected === 0) { statsContainer.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ã¾ã æ³¨æ„æˆåˆ†ã¯æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const maxCount = sorted[0][1];
            const colors = ['bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 'bg-lime-500'];
            sorted.forEach(([name, count], index) => {
                const percentage = (count / maxCount) * 100;
                const barColor = colors[index % colors.length];
                const html = `<div class="flex items-center justify-between text-sm mb-2"><span class="w-32 truncate font-bold text-gray-700" title="${name}">${name}</span><div class="flex-1 h-2.5 bg-gray-100 rounded-full overflow-hidden mx-3 relative"><div class="h-full ${barColor} rounded-full relative" style="width: ${percentage}%"></div></div><span class="text-gray-500 font-mono text-xs">${count}å›</span></div>`;
                statsContainer.insertAdjacentHTML('beforeend', html);
            });
        }
    </script>
</body>
</html>
